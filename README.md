# End to end tests

[![Build status](https://badge.buildkite.com/58730a2be16848255387f3c8fe708465d09e699794fff0fae4.svg)](https://buildkite.com/oasislabs/e2e-tests)

A set of Truffle based acceptance tests covering changes to the Ethereum runtime on the Oasis platform.

## Installation

Download the tests and install its dependencies.

`git clone https://github.com/oasislabs/e2e-tests.git`

`cd e2e-tests`

`npm install`

To make sure you're using the proper version of Rust, install [rustup](https://rustup.rs/)

`curl https://sh.rustup.rs -sSf | sh`

and set your default to nightly-2018-10-01.

`rustup default nightly-2018-10-01`

In order to compile to WASM, also run

`rustup target add wasm32-unknown-unknown`

`cargo install owasm-utils-cli --bin wasm-build`

Lastly, ensure you have access to the following repos

- https://github.com/oasislabs/dpml-rs
- https://github.com/oasislabs/ml-reader
- https://github.com/oasislabs/pwasm-ethereum-private

since they will be used by the contracts.

## Compile

```
npm run compile
```

This will store the contracts in the standard `build/contracts` directory generated by Truffle.

## Run tests against Devnet

To run tests against the Devnet, run

`MNEMONIC="<MNEMONIC>" npm run test:devnet [TEST_FILE_PATH]`

assigning the mnemonic associated with your Devnet wallet to the `MNEMONIC` environment variable. Optionally, one can include the path to a specific test file, e.g., `[TEST_FILE_PATH]` could be `test/logistic.js`. (Note that if you're running against the Devnet, you'll likely be rate limited since Truffle actively issues requests to the provider it's communicating with.)

## Run tests against a local testnet

To run tests against a local Oasis *testing* network, e.g., in C.I., first export the environment variables associated with your network. For example,

`export HTTPS_PROVIDER_URL="http://localhost:8545"`

`export WS_PROVIDER_URL="ws://localhost:8555"`

Then, similar to before, run the command

`MNEMONIC="<MNEMONIC>" npm run test:development [TEST_FILE_PATH]`,

this time specifiying your `MNEMONIC`, `development` and optionally the test file to run.

As with any Truffle project, one can add custom networks by modifying `truffle-config.js`. Note that we use a custom version of truffle so that we can work with Rust and Solidity in the same workspace. It will be downloaded when running `npm install` and located in your local `node_modules/`.
